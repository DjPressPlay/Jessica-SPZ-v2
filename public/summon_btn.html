<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Summon — Zetsu Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark">

<link rel="stylesheet" href="summon_style.css">
</head>
<body>

  <div class="frameType">
    <div id="inner" class="frameType-inner">
      <!-- Header -->
      <div class="card-header" role="group" aria-label="Card header">
        <div class="card-id" id="card-id" aria-label="Card ID"></div>
        <div class="card-name" aria-live="polite"><span id="card-name" class="autoscale" dir="auto"></span></div>
        <div class="card-icon" id="card-icon" aria-hidden="true"></div>
      </div>

      <!-- Artwork -->
      <div class="card-art">
        <img id="card-image" alt="" loading="lazy" decoding="async">
        <div class="stat-orb stat-blue"  id="level"></div>
        <div class="stat-orb stat-red"   id="atk"></div>
        <div class="stat-orb stat-green" id="def"></div>
      </div>

      <!-- Type Banner -->
      <div class="type-banner">
        <div class="type-cell"><span id="tribute" class="autoscale truncate" dir="auto"></span></div>
        <div class="type-about-wrap"><div class="type-about-box"><span id="about" class="type-about-text autoscale truncate" dir="auto"></span></div></div>
        <div class="type-cell"><span id="type-emoji" class="autoscale truncate" dir="auto"></span></div>
      </div>

      <!-- Effects -->
      <div class="effect-box" id="effect-box"></div>

      <!-- Sets + Tags -->
      <div class="meta-block">
        <div class="meta-line"><div class="meta-label">Sets -</div><div id="sets-line" class="meta-value"></div></div>
        <div class="meta-line"><div class="meta-label">Tags -</div><div id="tags-line" class="meta-value"></div></div>
      </div>

      <!-- Footer / Timestamp / Rarity -->
      <div class="meta-bottom">
        <div class="meta-footer-text" id="footer"></div>
        <div class="meta-timestamp" id="timestamp"></div>
        <div class="rarity" id="rarity"></div>
      </div>
    </div>
  </div>

<script>
/* ===== Load card from localStorage (exact key from Index/Preview) ===== */
let card = null;
try {
  const stored = localStorage.getItem("jessica_card");
  if (stored) card = JSON.parse(stored);
} catch(e){ console.error("Failed to read jessica_card:", e); }

if (!card) {
  // Minimal fallback so page doesn't break if nothing is saved yet
  card = {
    id:"-", name:"No Card Found", icon:"❌", about:"",
    tribute:"", effects:[], atk:"0", def:"0", level:"1", rarity:"Normal",
    tags:[], card_sets:[], timestamp:"", footer:"No saved card in localStorage",
    card_images:[], frameType:""
  };
}

/* ===== Frame color maps (same as preview) ===== */
const colorPalette = {
  "silver":"#C0C0C0","blue":"#0000FF","dark-blue":"#00008B","green":"#008000",
  "gold":"#FFD700","maroon":"#800000","bright-red":"#FF4949","sky-blue":"#87CEEB",
  "teal":"#008080","cyan":"#00FFFF","magenta":"#FF00FF","red-orange":"#FF4500",
  "sky-blue-light":"#ADD8E6","forest-green":"#228B22","orange":"#FFA500",
  "light-green":"#90EE90","violet":"#EE82EE","dark-violet":"#9400D3","peach":"#FFDAB9",
  "gray-gradient":"#D3D3D3","beige":"#F5F5DC","yellow-green":"#9ACD32","black":"#000000",
  "light-gray":"#D3D3D3","rose":"#FFC0CB","neon-yellow":"#FFFF00","peach-light":"#FFDAB9",
  "dark-red":"#8B0000","gray":"#808080","black-red-holo":"#8B0000","purple":"#6A0DAD",
  "neon-multicolor":"#FF00FF"
};
const card_type_map = {
  technology:{ color:"silver" }, science:{ color:"blue" }, investigative:{ color:"dark-blue" },
  sports:{ color:"green" }, business:{ color:"gold" }
};
const rarityBorder = {
  Normal:{ color:"#aaa", iridescent:false }, Rare:{ color:"#ddd", iridescent:false },
  SR:{ color:"#2d7bdc", iridescent:false }, UR:{ color:"#7c3aed", iridescent:false },
  Quantum:{ color:"#f1c40f", iridescent:false }, ZEOE:{ color:null, iridescent:true }
};

/* ===== Apply frame color / rarity (same behavior as preview) ===== */
(function applyFrame(){
  const inner = document.getElementById("inner");
  let baseColor = "#e63946";
  const ft = String(card.frameType||"").toLowerCase().replace(/\s+/g,"_");
  if (card_type_map[ft]) {
    const key = card_type_map[ft].color;
    if (colorPalette[key]) baseColor = colorPalette[key];
  }
  let useIri = false;
  const r = card.rarity;
  if (r && rarityBorder[r]) {
    if (rarityBorder[r].iridescent) useIri = true;
    else if (rarityBorder[r].color) baseColor = rarityBorder[r].color;
  }
  document.documentElement.style.setProperty("--frame-color", baseColor);
  inner.classList.toggle("iridescent", useIri);
})();

/* ===== Bind fields (no fake defaults) ===== */
const $ = id => document.getElementById(id);
$("card-id").textContent   = card.id || "";
$("card-name").textContent = card.name || "";
$("card-icon").textContent = card.icon || "";

/* image + alt */
const img = $("card-image");
img.src = (card.card_images && card.card_images[0] && card.card_images[0].image_url) ? card.card_images[0].image_url : "";
img.alt = (card.name ? card.name + " — artwork" : "Card artwork");

/* ===== Tribute/Level Derivation (keep preview behavior) ===== */
const typeInfo = { max_tributes: 6 }; // same cap

// Optional hooks (use if provided globally), else fallback to numeric/heuristic
const levelResolved = (typeof resolveLevel === "function")
  ? resolveLevel(card, typeInfo)
  : (Number(card.level) || 1);

const maxTributes = (typeInfo?.max_tributes ?? 6);

const tributesResolved = (typeof makeTributes === "function")
  ? makeTributes(levelResolved, maxTributes)
  : Math.min(levelResolved, maxTributes);

// Persist for downstream code like in preview
card.level = levelResolved;
card.tributes = (typeof card.tributes === "number") ? card.tributes : tributesResolved;

/* ===== Calculator (tribute-first) — IDENTICAL intent as preview ===== */
function countTributes(s){
  if (!s) return 0;
  // Count kneeling characters; supports 🙇 and 🙇‍♂️/🙇‍♀️ variants
  const kneel = (s.match(/🙇/gu) || []).length;
  // Legacy optional: count stars if used (safe default 0 if absent)
  const starsFallbackMatch = s.match(/⭐/gu);
  const starsFallback = starsFallbackMatch ? starsFallbackMatch.length : 0;
  return kneel || starsFallback;
}

function autoCalc(card) {
  const tributeCount =
    (typeof card.tributes === "number")
      ? card.tributes
      : countTributes(card.tribute);

  const level = tributeCount || (Number(card.level) || 1);
  const effectsCount = Array.isArray(card.effects) ? card.effects.length : 0;

  const atk = (level * 1000) + (effectsCount * 500);
  const def = Math.floor(atk / 2);

  return { level, atk, def };
}

/* ===== Stats bind (recomputed after retrieval) ===== */
const stats = autoCalc(card);
$("level").textContent = stats.level;
$("atk").textContent   = stats.atk;
$("def").textContent   = stats.def;

/* ===== Banner (show tribute as 🙇‍♂️ x count, like preview) ===== */
const TRIBUTE_EMOJI = "🙇‍♂️";
const tributeCountDisplay =
  (typeof card.tributes === "number") ? card.tributes : countTributes(card.tribute);
$("tribute").textContent   = TRIBUTE_EMOJI.repeat(tributeCountDisplay);
$("about").textContent     = card.about   || "";
$("type-emoji").textContent= card.icon    || "";

/* ===== Effects (node builder) ===== */
const effBox = $("effect-box");
effBox.replaceChildren();
(card.effects||[]).forEach(e=>{
  const entry = document.createElement("div"); entry.className="effect-entry";
  const bar   = document.createElement("div"); bar.className="effect-bar";
  const icons = document.createElement("div"); icons.textContent = e.icons || "";
  const emj   = document.createElement("div"); emj.textContent   = e.emoji || "";
  bar.append(icons, emj);
  const text  = document.createElement("div"); text.className="effect-text"; text.textContent = e.text || "";
  entry.append(bar, text);
  effBox.append(entry);
});

/* ===== Meta lines ===== */
$("sets-line").textContent = (Array.isArray(card.card_sets)?card.card_sets:[]).join(" ");
$("tags-line").textContent = (Array.isArray(card.tags)?card.tags:[]).join(" ");
$("footer").textContent    = card.footer    || "";
$("timestamp").textContent = card.timestamp || "";

/* ===== Rarity badge text + class (Quantum -> Q class) ===== */
const rb = $("rarity");
rb.textContent = card.rarity || "";
const rarityClassMap = { Normal:"Normal", Rare:"Rare", SR:"SR", UR:"UR", Quantum:"Q", ZEOE:"ZEOE" };
rb.classList.add(rarityClassMap[card.rarity] || (card.rarity || ""));

/* ===== Autoscale (same helpers as preview) ===== */
function autoscaleToLength(el, maxChars, minScale = 0.6){
  if(!el) return; el.style.setProperty('--scale','1');
  const len = [...(el.textContent || '').trim()].length;
  el.style.setProperty('--scale', String(len > maxChars ? Math.max(minScale, maxChars / len) : 1));
}
function autoshrinkFontToFit(el, { min=0.50, pad=4, squeezeLeft=null, squeezeRight=null, squeezePx=6 } = {}){
  if (!el || !el.parentElement) return;
  const base = parseFloat(el.dataset.baseFs || getComputedStyle(el).fontSize) || 14;
  el.dataset.baseFs = base; el.style.fontSize = base + 'px';
  if (squeezeLeft)  squeezeLeft.style.marginRight  = '';
  if (squeezeRight) squeezeRight.style.marginLeft  = '';
  let avail = Math.max(1, el.parentElement.clientWidth - pad);
  if (el.scrollWidth <= avail) return;
  if (squeezeLeft)  squeezeLeft.style.marginRight  = `-${squeezePx}px`;
  if (squeezeRight) squeezeRight.style.marginLeft  = `-${squeezePx}px`;
  avail = Math.max(1, el.parentElement.clientWidth - pad);
  const scale = Math.max(min, avail / el.scrollWidth);
  el.style.fontSize = (base * scale) + 'px';
}
function applyAutoscaleAll(){
  autoscaleToLength($('tribute'), 10, 0.6);
  autoscaleToLength($('type-emoji'), 8, 0.6);
  autoscaleToLength($('about'), 20, 0.75);
  const nameSpan = document.querySelector('.card-name span');
  autoshrinkFontToFit(nameSpan, {
    min:0.50, pad:4,
    squeezeLeft:  document.querySelector('.card-id'),
    squeezeRight: $('card-icon'),
    squeezePx:6
  });
}
applyAutoscaleAll();
if (document.fonts && document.fonts.ready) {
  document.fonts.ready.then(applyAutoscaleAll).catch(()=>{});
}

/* Throttle resize */
let rafId=null;
addEventListener('resize', () => {
  if (rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(()=>{ applyAutoscaleAll(); rafId=null; });
});
</script>
</body>
</html>
