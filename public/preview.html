<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Zetsu Card â€” Schema-Accurate Renderer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="color-scheme" content="dark">
<style>
  :root{
    --frame-color:#e63946;
    --frame-outer:#000;
    --text:#fff;
  }
  body{
    margin:0; background:#111; color:var(--text);
    font-family:"Orbitron",system-ui,Segoe UI,Arial,Helvetica,sans-serif;
    min-height:100vh; display:flex; align-items:center; justify-content:center; padding:16px;
  }

  /* Frame */
  .frameType{
    position:relative; overflow:hidden;
    border:12px solid var(--frame-outer); border-radius:14px;
    width:clamp(360px, 92vw, 460px);
  }
  .frameType-inner{
    position:relative; overflow:hidden; border:6px solid var(--frame-color); border-radius:10px;
    background:#1a1a1a;
  }
  .frameType-inner::before{
    content:""; position:absolute; inset:0;
    background:radial-gradient(120% 100% at 50% 0%, #1e1e1e 0%, #0e0e0e 65%, #111 100%);
    z-index:0;
  }
  .card-header, .card-art, .type-banner, .effect-box, .meta-block, .meta-bottom { position:relative; z-index:1; }

  /* Header */
  .card-header{
    display:flex; justify-content:space-between; align-items:center;
    background:#000; padding:6px 10px; font-size:.9rem; font-weight:800; text-transform:uppercase;
    border-bottom:2px solid var(--frame-color); border-top-left-radius:8px; border-top-right-radius:8px;
  }
  .card-id{ background:#fff; color:#000; padding:2px 6px; border-radius:4px; font-size:.75rem; white-space:nowrap; }
  .card-name{ flex:1; min-width:0; display:flex; justify-content:center; align-items:center; text-align:center; }
  .card-name span{
    display:inline-block; max-width:100%; white-space:nowrap;
    overflow:visible; text-overflow:unset;
    transform:scale(var(--scale,1)); transform-origin:center center; line-height:1;
  }
  .card-icon{ font-size:1.1rem; text-align:right; min-width:1.5em; }

  /* Artwork */
  .card-art{
    position:relative; margin:10px; background:#222; aspect-ratio:4/3;
    border:3px solid var(--frame-color); border-radius:8px; overflow:hidden;
  }
  .card-art img{ width:100%; height:100%; object-fit:cover; display:block; }

  /* Stat orbs */
  .stat-orb{
    position:absolute; width:54px; height:54px; border-radius:50%;
    font-weight:800; font-size:1.02rem; display:flex; align-items:center; justify-content:center;
    border:3px solid #fff; box-shadow:0 2px 8px rgba(0,0,0,.4);
  }
  .stat-blue  { background:#3498db; top:6px;  left:6px; }
  .stat-red   { background:#e63946; bottom:6px; left:6px; }
  .stat-green { background:#2ecc71; bottom:6px; right:6px; }

  /* Type Banner (TRIBUTE | ABOUT | EMOJI) */
  .type-banner{
    background:#000; color:#fff; padding:6px 10px; font-weight:800;
    border-top:2px solid var(--frame-color); border-bottom:2px solid var(--frame-color);
    display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px;
  }
  .type-cell{ display:flex; justify-content:center; align-items:center; min-width:0; }
  .type-about-wrap{ display:flex; justify-content:center; align-items:center; min-width:0; }
  .type-about-box{
    display:inline-flex; align-items:center; justify-content:center;
    padding:4px 12px; border:2px solid var(--frame-color); border-radius:6px;
    background:#0b0b0b; box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);
    max-width:100%;
  }
  .type-about-text{ font-size:.95rem; letter-spacing:.02em; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:280px; }
  @media (max-width:480px){ .type-about-text{ max-width:200px; } }
  .truncate{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
  .autoscale{ display:inline-block; transform:scale(var(--scale,1)); transform-origin:center center; line-height:1; }

  /* Effects */
  .effect-box{
    background:#000; border-top:2px solid var(--frame-color); border-bottom:2px solid var(--frame-color);
    padding:10px; display:flex; flex-direction:column; gap:8px;
  }
  .effect-entry{ border:1px solid #2a2a2a; background:#0f0f0f; border-radius:8px; padding:8px 10px; }
  .effect-bar{ display:flex; justify-content:space-between; align-items:center; font-size:.92rem; margin-bottom:4px; }
  .effect-text{ font-size:.84rem; line-height:1.32; }

  /* Meta (Sets + Tags in one bracket) */
  .meta-block{
    border-top:2px solid var(--frame-color); border-bottom:2px solid var(--frame-color);
    background:#000; padding:8px 10px; display:flex; flex-direction:column; gap:6px;
  }
  .meta-line{ display:flex; gap:8px; align-items:center; font-size:.78rem; color:#ccc; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .meta-label{ font-weight:800; text-transform:uppercase; color:#eee; letter-spacing:.02em; }
  .meta-value{ flex:1; min-width:0; opacity:.95; white-space:normal; word-break:break-word; }

  /* Bottom bar */
  .meta-bottom{
    position:relative; border-top:2px solid var(--frame-color);
    background:#111; padding:10px 12px 32px; text-align:center; color:#ccc;
  }
  .meta-footer-text{ font-size:.72rem; color:#cfcfcf; line-height:1.25; }
  .meta-timestamp{ margin-top:4px; font-size:.66rem; color:#9f9f9f; }
  .meta-bottom .rarity{
    position:absolute; right:10px; bottom:6px;
    font-weight:800; letter-spacing:.02em;
    border:1px solid rgba(255,255,255,.2); padding:2px 8px; border-radius:4px;
  }
  .rarity.SR{ background:#2d7bdc; }
  .rarity.UR{ background:#7c3aed; }
  .rarity.Q { background:#f1c40f; color:#111; }
  .rarity.ZEOE{
    color:#fff;
    background:conic-gradient(from 0deg, #ff0040, #ffd200, #00ffcc, #00a2ff, #ff4dff, #ff0040);
    background-size:200% 200%; animation:holoShift 6s linear infinite;
    border:1px solid rgba(255,255,255,.35); text-shadow:0 0 6px rgba(255,255,255,.35);
  }
  @keyframes holoShift{ 0%{background-position:0% 50%} 100%{background-position:200% 50%} }
  @media (prefers-reduced-motion: reduce){ .rarity.ZEOE{ animation:none; } }

  /* Iridescent shine when rarity triggers it */
  .frameType-inner.iridescent::after{
    content:"";
    position:absolute; inset:-2px; pointer-events:none; z-index:2;
    background:
      conic-gradient(from 0deg,
        rgba(255,0,64,.35),
        rgba(255,210,0,.35),
        rgba(0,255,204,.35),
        rgba(0,162,255,.35),
        rgba(255,77,255,.35),
        rgba(255,0,64,.35)
      );
    -webkit-mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    padding:3px; border-radius:12px;
    animation: holoSweep 8s linear infinite;
  }
  @keyframes holoSweep { to { transform: rotate(360deg); } }
  @media (prefers-reduced-motion: reduce){ .frameType-inner.iridescent::after{ animation:none; } }

  /* Artwork fallback */
  .card-art::before{
    content:""; position:absolute; inset:0; z-index:0;
    background:
      radial-gradient(120% 100% at 50% 0%, #1e1e1e 0%, #0e0e0e 65%, #111 100%),
      repeating-linear-gradient(135deg, rgba(255,255,255,.05) 0 2px, transparent 2px 6px);
  }
  .card-art img[src=""], .card-art img:not([src]){ opacity:0; }
</style>
</head>
<body>

  <div class="frameType">
    <div id="inner" class="frameType-inner">
      <!-- Header -->
      <div class="card-header" role="group" aria-label="Card header">
        <div class="card-id" id="card-id" aria-label="Card ID"></div>
        <div class="card-name" aria-live="polite"><span id="card-name" class="autoscale" dir="auto"></span></div>
        <div class="card-icon" id="card-icon" aria-hidden="true"></div>
      </div>

      <!-- Artwork -->
      <div class="card-art">
        <img id="card-image" alt="" loading="lazy" decoding="async">
        <div class="stat-orb stat-blue"  id="level"></div>
        <div class="stat-orb stat-red"   id="atk"></div>
        <div class="stat-orb stat-green" id="def"></div>
      </div>

      <!-- Type Banner -->
      <div class="type-banner">
        <div class="type-cell"><span id="tribute" class="autoscale truncate" dir="auto"></span></div>
        <div class="type-about-wrap"><div class="type-about-box"><span id="about" class="type-about-text autoscale truncate" dir="auto"></span></div></div>
        <div class="type-cell"><span id="type-emoji" class="autoscale truncate" dir="auto"></span></div>
      </div>

      <!-- Effects -->
      <div class="effect-box" id="effect-box"></div>

      <!-- Sets + Tags -->
      <div class="meta-block">
        <div class="meta-line"><div class="meta-label">Sets -</div><div id="sets-line" class="meta-value"></div></div>
        <div class="meta-line"><div class="meta-label">Tags -</div><div id="tags-line" class="meta-value"></div></div>
      </div>

      <!-- Footer / Timestamp / Rarity -->
      <div class="meta-bottom">
        <div class="meta-footer-text" id="footer"></div>
        <div class="meta-timestamp" id="timestamp"></div>
        <div class="rarity" id="rarity"></div>
      </div>
    </div>
  </div>

<script>
/* ===== Frame color maps ===== */
const colorPalette = {
  "silver":"#C0C0C0","blue":"#0000FF","dark-blue":"#00008B","green":"#008000",
  "gold":"#FFD700","maroon":"#800000","bright-red":"#FF4949","sky-blue":"#87CEEB",
  "teal":"#008080","cyan":"#00FFFF","magenta":"#FF00FF","red-orange":"#FF4500",
  "sky-blue-light":"#ADD8E6","forest-green":"#228B22","orange":"#FFA500",
  "light-green":"#90EE90","violet":"#EE82EE","dark-violet":"#9400D3","peach":"#FFDAB9",
  "gray-gradient":"#D3D3D3","beige":"#F5F5DC","yellow-green":"#9ACD32","black":"#000000",
  "light-gray":"#D3D3D3","rose":"#FFC0CB","neon-yellow":"#FFFF00","peach-light":"#FFDAB9",
  "dark-red":"#8B0000","gray":"#808080","black-red-holo":"#8B0000","purple":"#6A0DAD",
  "neon-multicolor":"#FF00FF"
};
const card_type_map = {
  technology:{ color:"silver" }, science:{ color:"blue" }, investigative:{ color:"dark-blue" },
  sports:{ color:"green" }, business:{ color:"gold" }
};
const rarityBorder = {
  Normal:{ color:"#aaa", iridescent:false }, Rare:{ color:"#ddd", iridescent:false },
  SR:{ color:"#2d7bdc", iridescent:false }, UR:{ color:"#7c3aed", iridescent:false },
  Quantum:{ color:"#f1c40f", iridescent:false }, ZEOE:{ color:null, iridescent:true }
};

/* ===== Helpers ===== */
const $ = id => document.getElementById(id);
const STORAGE_KEY = "jessica_card";

function safeParse(json){
  try { return JSON.parse(json); } catch { return null; }
}
function getCardFromIndex(){
  // 1) localStorage (set by index page)
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    const obj = safeParse(raw);
    if (obj && typeof obj === "object") return obj;
  }
  // 2) URL param ?card=<base64/json-encoded> (optional convenience)
  const p = new URLSearchParams(location.search);
  if (p.has("card")){
    try {
      const val = decodeURIComponent(p.get("card"));
      const obj = safeParse(val);
      if (obj) return obj;
    } catch {}
  }
  // 3) openerâ€™s storage (if allowed)
  try {
    if (window.opener) {
      const raw2 = window.opener.localStorage.getItem(STORAGE_KEY);
      const obj2 = safeParse(raw2);
      if (obj2) return obj2;
    }
  } catch {}
  return null;
}

/* ===== Frame color / rarity ===== */
function applyFrame(card){
  const inner = document.getElementById("inner");
  let baseColor = "#e63946";
  const ft = String(card.frameType||"").toLowerCase().replace(/\s+/g,"_");
  if (card_type_map[ft]) {
    const key = card_type_map[ft].color;
    if (colorPalette[key]) baseColor = colorPalette[key];
  }
  let useIri = false; const r = card.rarity;
  if (r && rarityBorder[r]) {
    if (rarityBorder[r].iridescent) useIri = true;
    else if (rarityBorder[r].color) baseColor = rarityBorder[r].color;
  }
  document.documentElement.style.setProperty("--frame-color", baseColor);
  inner.classList.toggle("iridescent", useIri);
}

/* ===== Tribute/Stats ===== */
const typeInfo = { max_tributes: 10 };

function countTributesFromString(s){
  if (!s) return 0;
  return (String(s).match(/ðŸ™‡/gu) || []).length;
}
function resolveTributes(card){
  // prefer numeric fields (tributes or level), else count ðŸ™‡
  if (typeof card.tributes === "number") return Math.max(0, Math.min(typeInfo.max_tributes, Math.floor(card.tributes)));
  const lvl = Number(card.level);
  if (!Number.isNaN(lvl) && lvl >= 0) return Math.max(0, Math.min(typeInfo.max_tributes, Math.floor(lvl)));
  return Math.max(0, Math.min(typeInfo.max_tributes, countTributesFromString(card.tribute)));
}
function computeStats(card){
  const trib = resolveTributes(card);
  const effectsCount = Array.isArray(card.effects) ? card.effects.length : 0;
  const level = trib;
  const atk = (level * 1000) + (effectsCount * 500);
  const def = Math.floor(atk / 2);
  return { level, atk, def, tributeString: "ðŸ™‡â€â™‚ï¸".repeat(trib) };
}

/* ===== Bind & Render ===== */
function renderCard(card){
  applyFrame(card);

  // header
  $("card-id").textContent   = card.id || "";
  $("card-name").textContent = card.name || "";
  $("card-icon").textContent = card.icon || "";

  // artwork
  const img = $("card-image");
  img.src = (card.card_images && card.card_images[0] && card.card_images[0].image_url) ? card.card_images[0].image_url : "";
  img.alt = (card.name ? card.name + " â€” artwork" : "Card artwork");

  // stats from tributes/effects
  const stats = computeStats(card);
  $("level").textContent = String(stats.level);
  $("atk").textContent   = String(stats.atk);
  $("def").textContent   = String(stats.def);

  // banner
  $("tribute").textContent    = stats.tributeString || card.tribute || "";
  $("about").textContent      = card.about   || "";
  $("type-emoji").textContent = card.icon    || "";

  // effects
  const effBox = $("effect-box");
  effBox.replaceChildren();
  (card.effects||[]).forEach(e=>{
    const entry = document.createElement("div"); entry.className="effect-entry";
    const bar = document.createElement("div"); bar.className="effect-bar";
    const icons = document.createElement("div"); icons.textContent = e.icons || "";
    const emj   = document.createElement("div"); emj.textContent   = e.emoji || "";
    bar.append(icons, emj);
    const text = document.createElement("div"); text.className="effect-text"; text.textContent = e.text || "";
    entry.append(bar, text);
    effBox.append(entry);
  });

  // meta
  $("sets-line").textContent = (Array.isArray(card.card_sets)?card.card_sets:[]).join(" ");
  $("tags-line").textContent = (Array.isArray(card.tags)?card.tags:[]).join(" ");
  $("footer").textContent    = card.footer    || "";
  $("timestamp").textContent = card.timestamp || "";

  // rarity badge
  const rb = $("rarity");
  rb.textContent = card.rarity || "";
  rb.className = "rarity"; // reset
  const rarityClassMap = { Normal:"Normal", Rare:"Rare", SR:"SR", UR:"UR", Quantum:"Q", ZEOE:"ZEOE" };
  rb.classList.add(rarityClassMap[card.rarity] || (card.rarity || ""));

  applyAutoscaleAll();
}

/* ===== Autoscale ===== */
function autoscaleToLength(el, maxChars, minScale = 0.6){
  if(!el) return; el.style.setProperty('--scale','1');
  const len = [...(el.textContent || '').trim()].length;
  el.style.setProperty('--scale', String(len > maxChars ? Math.max(minScale, maxChars / len) : 1));
}
function autoshrinkFontToFit(el, { min=0.50, pad=4, squeezeLeft=null, squeezeRight=null, squeezePx=6 } = {}){
  if (!el || !el.parentElement) return;
  const base = parseFloat(el.dataset.baseFs || getComputedStyle(el).fontSize) || 14;
  el.dataset.baseFs = base; el.style.fontSize = base + 'px';
  if (squeezeLeft)  squeezeLeft.style.marginRight  = '';
  if (squeezeRight) squeezeRight.style.marginLeft  = '';
  let avail = Math.max(1, el.parentElement.clientWidth - pad);
  if (el.scrollWidth <= avail) return;
  if (squeezeLeft)  squeezeLeft.style.marginRight  = `-${squeezePx}px`;
  if (squeezeRight) squeezeRight.style.marginLeft  = `-${squeezePx}px`;
  avail = Math.max(1, el.parentElement.clientWidth - pad);
  const scale = Math.max(min, avail / el.scrollWidth);
  el.style.fontSize = (base * scale) + 'px';
}
function applyAutoscaleAll(){
  autoscaleToLength(document.getElementById('tribute'), 10, 0.6);
  autoscaleToLength(document.getElementById('type-emoji'), 8, 0.6);
  autoscaleToLength(document.getElementById('about'), 20, 0.75);
  const nameSpan = document.querySelector('.card-name span');
  autoshrinkFontToFit(nameSpan, {
    min:0.50, pad:4,
    squeezeLeft: document.querySelector('.card-id'),
    squeezeRight: document.getElementById('card-icon'),
    squeezePx:6
  });
}

/* ===== Boot ===== */
(function boot(){
  const card = getCardFromIndex();
  if (!card) {
    // graceful empty-state
    document.querySelector('.frameType-inner').innerHTML = `
      <div style="padding:24px; text-align:center">
        <div style="font-size:18px; font-weight:800; margin-bottom:8px;">No card found</div>
        <div style="font-size:14px; color:#ccc;">
          Go back to the Index and run the Creation Ritual. A card will be saved to <code>localStorage["jessica_card"]</code>.
        </div>
      </div>`;
    return;
  }
  renderCard(card);
})();

/* Re-apply autoscale after fonts load and on resize */
if (document.fonts && document.fonts.ready) { document.fonts.ready.then(applyAutoscaleAll).catch(()=>{}); }
let rafId=null;
addEventListener('resize', () => {
  if (rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(()=>{ applyAutoscaleAll(); rafId=null; });
});
</script>
</body>
</html>
